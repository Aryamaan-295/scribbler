sandbox = {};
file_details={};

load_file_click=function() {
	load_file().then(x=>load_jsnb(x))


	}
	
run_all=function(){

    // Send a message object to the iframe
   
      const message = {
        action:"run_all",
        data:""      
       };
      sandbox.contentWindow.postMessage(message, '*');

}
download_nb=function(){

    // Send a message object to the iframe
   
      const message = {
        action:"get_nb",
        data:"",
        call_bk:"download_nb"
      };
      sandbox.contentWindow.postMessage(message, '*');
    
    

 	
}

download_js=function(){
 	
 	const message = {
        action:"get_nb",
        data:"",
        call_bk:"download_js"
      };
      sandbox.contentWindow.postMessage(message, '*');
    

}

load_jsnb=function(content){

      const message = {
        action:"load_jsnb",
        data:content,
        call_bk:""
      };
      
      sandbox.contentWindow.postMessage(message, '*');
      
      var nb=JSON.parse(content);
      var run_on_load = nb.run_on_load || false;
      get_dom("nb_name").innerHTML=nb.metadata.name;
      document.title = nb.metadata.name+":  Scribbler JavaScript Notebook";
      var metaDescription = document.querySelector('meta[name="description"]');

	// Set the description dynamically
	var newDescription = nb.metadata.name+" - Notebook for experimenting in JavaScript. Contains editable code and output. Play with html and code using a simple interface - Scribbler.";
	metaDescription.setAttribute("content", newDescription);
      get_dom("run_on_load").checked=run_on_load;
     
	

}

download_html=function(view){

    // Send a message object to the iframe
   
      const message = {
        action:"get_html",
        data:{view:view},
        call_bk:"download_html"
      };
      sandbox.contentWindow.postMessage(message, '*');
    
   
}

insert_cell=function(type){
	 // Send a message object to the iframe
   
      const message = {
        action:"insert_cell",
        data:{type:type},
        call_bk:""
      };
      sandbox.contentWindow.postMessage(message, '*');
}

message_handlers={
	"initialize_sandbox":async function(data,call_bk){
		var url='';
 		try{ 
 			const urlParams = new URLSearchParams(window.location.search);
			const jsnb_path = urlParams.get('jsnb');
			if(jsnb_path !=null && typeof jsnb_path!=='undefined') url=jsnb_path;
 			else url=window.location.href.split("#")[1];
 		} catch(e){url="./examples/Hello-world.jsnb"}
 		if(url==undefined) url="./examples/Hello-world.jsnb";
	  	if( url.length>1){
	  		if(url.split(":")[0].trim()=='github') initialize_from_git(url.split(":")[1].trim());
	  		else read_file(url,load_jsnb,err=>{alert(err.message)});
	  	}else{
	  		
	  		get_dom("nb_name").innerHTML="New JSNB";
	  		insert_cell("code");
	  	}
 	},
 	"download_nb":async function(data,call_bk){
		data['run_on_load'] = get_dom("run_on_load").checked;
		let url='';
		let file_name='';
		try{ 
		
 			const urlParams = new URLSearchParams(window.location.search);
			const jsnb_path = urlParams.get('jsnb');
			if(jsnb_path !=null && typeof jsnb_path!=='undefined') url=jsnb_path;
 			else url=window.location.href.split("#")[1];
 		} catch(e){
 			console.log(e);
 			url=''
 		}
 		
 		if(url!=undefined && url.length>1){
	  		 file_name = url.split('/').slice(-1)[0]
	  	}else{
	  		
	  		 data.metadata.name=get_dom("nb_name").innerHTML;
	  		 file_name=data.metadata.name.replaceAll(' ','_')+'.jsnb'
	  	}
 		download_string(JSON.stringify(data,undefined,2),file_name,"data:text/json;charset=utf-8");	
 	},
 	"download_html":async function(data,call_bk){
 		let file_name=get_dom("nb_name").innerHTML.replaceAll(' ','_')+'.html';
 		download_string(data['html'],file_name,"data:text/html;charset=utf-8");	
 	},
 	"download_js":async function(data,call_bk){
	 	js=data.cells.filter(x=>x.type=='code').map(x=>x['code']);
	 	js=js.join("\n/*---------*/\n");
	 	js="/*Generated by JSNB: https://github.com/gopi-suvanam/jsnb*/\n\n"+js;
	 	let file_name=get_dom("nb_name").innerHTML.replaceAll(' ','_')+'.js';
	 	download_string(js,file_name,"data:text/js;charset=utf-8");

 	},
 	"upload_to_git":async function(data,call_bk){
 		data['run_on_load'] = get_dom("run_on_load").checked;
 		data.metadata.name=get_dom("nb_name").innerHTML;
 		
 		content=JSON.stringify(data,undefined,2);
		upload_file_to_git(file_details['token'],content,file_details['user'],file_details['repo'],file_details['path'])
		.then(x=>{
			alert("Successfully pushed");
			closeModal(get_dom('git-import-export'));
				const nextURL = `#github:${file_details['user']}/${file_details['repo']}/${file_details['path']}`;
				const nextTitle = 'JavaScript Notebook';
				const nextState = { additionalInformation: 'Updated the URL with JS' };
				window.history.pushState(nextState, nextTitle, nextURL);
	
			})
		.catch(error=>{alert("Error: "+error)})
 	}

}
insitialize_page=async function(){
	sandbox = await wait_for_dom('sandbox');
	
  	document.onkeyup = function(e) {
	  if (e.ctrlKey && e.key === 's') {
	    download_nb();
	  } else if (e.ctrlKey && e.key === 'g') {
	    openModal(get_dom('git-import-export'));
	  } else if (e.ctrlKey && e.key === 'o') {
	    load_file_click()
			
	  }
	  else if (e.altKey && e.key === 'Â®') {
	    run_all()
			
	  }
	  else if (e.altKey && e.key === 'r') {
	    run_all()
			
	  }
	};
	
	window.addEventListener('message', function(event) {
	      if (event.source === sandbox.contentWindow) {
	        const message = event.data;
	        console.log(message);
	        message_handlers[message.action](message.data,null);
	      }
	    });
	  	
}

